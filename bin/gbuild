#!/bin/bash
#
# /Users/rbe/project/grooutils/bin/gbuild
# 
# Copyright (C) 2010 Informationssysteme Ralf Bensmann.
# Alle Rechte vorbehalten. Nutzungslizenz siehe http://www.bensmann.com/license_de.html
# All Rights Reserved. Use is subject to license terms, see http://www.bensmann.com/license_en.html
# 
# Created by: rbe
#

# Determine script directory
case $0 in
	./*) SCRIPT_DIR=${PWD} ;;
	/*) SCRIPT_DIR=${0%/*} ;;
	*/*) SCRIPT_DIR=${PWD}/${0%/*} ;;
	*) SCRIPT_DIR=${PWD} ;;
esac
# Set basic variables
pushd ${SCRIPT_DIR}/.. 2>/dev/null
BASE=${2:-$(pwd)}
APPNAME=$(basename $BASE)
popd 2>/dev/null
BIN=$BASE/bin
CONF=$BASE/conf
SRC=$BASE/src
LIB=$BASE/lib
CLASSES=$BASE/classes
DIST=$BASE/dist

_create_dirs() {
	echo "Creating directories in $BASE"
	mkdir -p $BIN $CONF $SRC $LIB $CLASSES $DIST
}

_init_git() {
	echo "Initializing Git for $BASE"
	cd $BASE
	git init
}

_make_cp() {
	cp $GROOVY_HOME/embeddable/groovy-all-*.jar $LIB
	for lib in $LIB/*.jar
	do
		CP="$CP:$lib"
	done
	echo $CP | cut -c 2-
}

_clean() {
	echo "Cleaning up..."
	_create_dirs
	rm -rf $CLASSES/*
	rm -rf $DIST/*
}

_compile() {
	echo "Compiling classes..."
	cd $SRC
	find . -type f -name \*.java -print0 | xargs -0 javac -d $CLASSES -cp "$(_make_cp)"
	find . -type f -name \*.groovy -print0 | xargs -0 groovyc -d $CLASSES -cp "$CLASSES:$(_make_cp)"
	# Resources folder?
	if [ -d resources ]; then
		cp -R resources/* ../classes
	fi
}

_jar() {
	_compile
	echo "Creating jar"
	rm $LIB/${APPNAME}.jar
	cd $CLASSES
	jar cf $LIB/${APPNAME}.jar *
}

_dist() {
	_clean && _jar
	if [ $? -eq 0 ]; then
		echo "Creating distribution"
		t=t$$/${APPNAME}
		mkdir -p $t
		cd $t
		mkdir lib && cp -R $LIB/*.jar lib
		mkdir conf && cp $CONF/* conf
		cp $BIN/runme* .
		cd ..
		zip -rm $BASE/dist.zip ${APPNAME}
		cd ..
		rm -rf $t
	fi
}

case "$1" in
	setup)
		_create_dirs
		_init_git
	;;
	clean)
		_clean
	;;
	compile)
		_compile
	;;
	jar)
		_jar
	;;
	dist)
		_dist
	;;
	run)
		$0 jar
		cp="$(_make_cp lib)"
		echo "Classpath: $cp"
		# TODO
		java -cp $cp Main
	;;
	*)
		echo "usage: $0 { setup | clean | compile | jar | dist | run } $2"
	;;
esac

exit 0
